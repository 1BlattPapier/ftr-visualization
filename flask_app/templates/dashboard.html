<!DOCTYPE html>
<html>
<head>
  <style>
    .error {
        color: red;
    }
  </style>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script type="text/javascript" src="https://d3js.org/d3-selection.v1.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm//vega@5"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm//vega-lite@4.8.1"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm//vega-embed@6"></script>
</head>
<body>
  <h3 id="vis_ttl" style="font-family: Helvetica;">Future time reference visualisation</h3>
  <div id="vis"></div>
  <div class="pb-5 ">
    <label for="yearRange" class="form-label">Year to display</label>
    <input type="range" class="form-range" min="2005" max="2022" step="1" id="yearRange" onchange="reloadData()">
  </div>
  
  <script>
    var divElement = d3.select('#vis');
    var titleElement = d3.select('#vis_ttl');
    var visualize = function(vegaEmbed, width, height, el, start_year) {
      var end_year = start_year + 1;
      var url = "http://127.0.0.1:5000/data?st_year=" + start_year + "&end_year=" + end_year

      var scatter = {
        "mark": "circle",
        "encoding": {
          "color": {
            "condition": {
              "selection": {
                "or": [
                  "selectorTopic",
                  "selectorEmotion"
                ]
              }
            },
            "value": "lightgray"
          },
          "tooltip": [
            {
              "type": "nominal",
              "field": "text"
            },
            {
              "type": "nominal",
              "field": "topics"
            },
            {
              "type": "nominal",
              "field": "emotions"
            },
          ],
          "x": {
            "type": "quantitative",
            "field": "x"
          },
          "y": {
            "type": "quantitative",
            "field": "y"
          }
        },
        "height": width,
        "selection": {
          "selectorTooltip": {
            "type": "interval",
            "bind": "scales",
            "encodings": [
              "x",
              "y"
            ]
          }
        },
        "width": height,
      };

      var topic_bar = {
        "mark": "bar",
        "encoding": {
          "color": {
            "condition": {
              "selection": "selectorTopic"
            },
            "value": "lightgray"
          },
          "x": {
            "type": "quantitative",
            "aggregate": "count",
            "axis": {
              "title": ""
            }
          },
          "y": {
            "type": "nominal",
            "axis": {
              "labelFontSize": 11,
              "ticks": false,
              "title": ""
            },
            "field": "topics_flattened",
            "sort": "-x"
          }
        },
        "selection": {
          "selectorTopic": {
            "type": "multi",
            "fields": [
              "topics_flattened"
            ]
          }
        },
        "height": height * (10 / 35),
        "width": width / 2,
        "title": "Topic"
      };

      var emotion_bar = {
        "mark": "bar",
        "encoding": {
          "color": {
            "condition": {
              "selection": "selectorEmotion"
            },
            "value": "lightgray"
          },
          "x": {
            "type": "quantitative",
            "aggregate": "count",
            "axis": {
              "title": ""
            }
          },
          "y": {
            "type": "nominal",
            "axis": {
              "labelFontSize": 11,
              "ticks": false,
              "title": ""
            },
            "field": "emotions_flattened",
            "sort": "-x"
          }
        },
        "selection": {
          "selectorEmotion": {
            "type": "multi",
            "fields": [
              "emotions_flattened"
            ]
          }
        },
        "height": height * (25 / 35),
        "width": width / 2,
        "title": "Emotion"
      };

      var spec = {
        "config": {
          "view": {
            "continuousWidth": 400,
            "continuousHeight": 300
          }
        },
        "data": {
          "url": url,
          "format": {
            "type": "json"
          }
        },
        "transform": [
          {
            "flatten": ["topics"],
            "as": ["topics_flattened"]
          },
          {
            "flatten": ["emotions"],
            "as": ["emotions_flattened"]
          },
        ],
        "hconcat": [
          scatter,
          {
            "vconcat": [
              topic_bar,
              emotion_bar
            ]
          }
        ],
        "$schema": "https://vega.github.io/schema/vega-lite/v4.8.1.json"
      };
      var embedOpt = {"mode": "vega-lite"};

      function showError(el, error){
          el.innerHTML = ('<div class="error" style="color:red;">'
                          + '<p>JavaScript Error: ' + error.message + '</p>'
                          + "<p>This usually means there's a typo in your chart specification. "
                          + "See the javascript console for the full traceback.</p>"
                          + '</div>');
          throw error;
      }
      vegaEmbed("#vis", spec, embedOpt)
        .then(p => window.view = p.view)
        .catch(error => showError(el, error));
    };
    var resizeTimer;
    d3.select(window).on('resize', function(){
      if(resizeTimer){
        clearTimeout(resizeTimer);
      }
      resizeTimer = setTimeout(resize, 100);
    });
    function resize(){
      divElement.selectAll("*").remove();

      // calculate width and height of vis
      var w, h, th;
      var style = window.getComputedStyle ? getComputedStyle(titleElement.node(), null) : titleElement.node().currentStyle;
      var mt = parseInt(style.marginTop) || 0;
      var mb = parseInt(style.marginBottom) || 0;

      if(window.innerHeight){
        w = window.innerWidth;
        h = window.innerHeight;
      }else{
        w = document.documentElement.clientWidth;
        h = document.documentElement.clientHeight;
      }
      console.log(mt, mb);
      th = titleElement.node().clientHeight + mt + mb;
      if(h > th){
        h = h - th;
      }
      h = 0.9 * h;
      if(w > h){
        w = h;
      }

      var start_year = parseInt(document.getElementById("yearRange").value);

      visualize(vegaEmbed, w, w, divElement.node(), start_year);
    }
    resize();

    var reloadData = function() {
      var start_year = parseInt(document.getElementById("yearRange").value);
      var end_year = start_year + 1;
      var url = "http://127.0.0.1:5000/data?st_year=" + start_year + "&end_year=" + end_year
      fetch(url).then(r => r.json()).then(data => {
        // Changeset needs to remove everything first, then insert new data
        let changeset = vega.changeset().remove(() => true).insert(data);
        // For some reason source_0 is the default dataset name
        view.change('source_0', changeset).run()
      });
    }
    
  </script>
</body>
</html>
